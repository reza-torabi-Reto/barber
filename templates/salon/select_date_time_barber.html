<!-- salon/templates/salon/select_date_time.html -->
{% extends 'base.html' %}
{% load custom_filters %}
{% block title %}نوبت آرا | پرونده {{ user.nickname }}{% endblock %}
{% block mycss %}
<style>
    .date-scroll-container {
        display: flex;
        overflow-x: auto;
        padding: 10px 0;
        gap: 0.5rem;
        scroll-snap-type: x mandatory;
    }

    .date-btn {
        flex: 0 0 auto;
        scroll-snap-align: start;
        white-space: nowrap;
        min-width: 160px;
        border-radius: 12px;
        background-color: #4a6cf7;
        color: white;
    }
    .times-btn{
        border: 1px solid #28a745;
    }
    .date-scroll-container::-webkit-scrollbar {
        height: 8px;
    }

    .date-scroll-container::-webkit-scrollbar-thumb {
        background: #007bff;
        border-radius: 4px;
    }
</style>
{% endblock %}
{% block navleft %}
<a href="{% url 'account:customer_profile' %}" class="btn btn_nav">پروفایل</a>
<a href="{% url 'salon:book_appointment' shop.id %}" class="btn btn_nav">بازگشت به مرحله قبل</a>
{% endblock %}
{% block navright %}
<div class="d-flex align-items-baseline justify-content-end">
    <h1>آرایشگر من</h1>
</div>
{% endblock %}

{% block content %}

<div class="row justify-content-center mb-4">
    <div class="col-md-6">
        <div class="card shadow rounded-4">
            <div class="card-body p-4">
                <h5 class="mb-4 text-center">انتخاب آرایشگر و خدمت</h5>
                
                <div class="row">
                    {% if error %}
                    <div class="col">
                        <div class="alert alert-danger">{{ error }}</div>
                    </div>
                    {% endif %}
                </div>

                <div class="profile_manager_info">
                    <label for="" class="text-center">آرایشگر:</label>
                    {{ barber.nickname }}
                </div>
                
                <div class="profile_manager_info flex-column align-items-start pb-4">
                    <label for="" class="text-center mb-2">سرویس‌ها:</label>
                    <ul class="m-0 p-0">
                        {% for service in services %}
                        <li class="rounded">{{ service.name }} : ({{ service.duration }} دقیقه) - ({{service.price}} تومان)</li>
                        {% endfor %}
                    </ul>
                </div>
                <hr>
                <h5 class="mb-4 text-center">انتخاب روز</h5>
                {% if dates %}
                <div class="date-scroll-container">
                    {% for date in dates %}
                    <button type="button" class="btn btn-outline-primary date-btn"
                        onclick="loadTimes('{{ date.gregorian_date|date:'Y-m-d' }}')">
                        {{ date.day_of_week }}<br>{{ date.jalali_date }}
                    </button>
                    {% endfor %}
                </div>
                {% else %}
                <p>هیچ روز آزادی برای رزرو در دسترس نیست.</p>
                {% endif %}
                <hr>
                <h5 class="mb-4 text-center">انتخاب زمان</h5>
                <div id="time-slots" class="time-slot text-center">
                    <p>لطفاً یک روز انتخاب کنید.</p>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block myjs %}
<script>
    const getTimesUrl = "{% url 'salon:get_available_times' %}";
    const serviceIds = {{ appointment_data.services|safe }};
    const barberId = {{ appointment_data.barber_id }};
    const shopId = {{ appointment_data.shop_id }};
    
    function loadTimes(date) {
        const serviceParams = serviceIds.map(id => `services=${id}`).join('&');        
        const url = `${getTimesUrl}?shop_id=${shopId}&barber_id=${barberId}&date=${date}&${serviceParams}`;
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`خطای شبکه: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                const timeSlots = document.getElementById('time-slots');
                timeSlots.innerHTML = '';
                
                if (!data.times || data.times.length === 0) {
                    timeSlots.innerHTML = '<p class="text-muted">هیچ زمان آزادی برای این روز وجود ندارد.</p>';
                    return;
                }
                
                data.times.forEach(time => {
                    const slotLink = document.createElement('a');
                    // ساخت URL با استفاده از template literals
                    slotLink.href = `{% url 'salon:confirm_appointment' %}?date=${date}&time=${encodeURIComponent(time.start_time)}`;
                    slotLink.className = 'btn btn-outline-success times-btn m-2';
                    slotLink.textContent = `${time.start_time} - ${time.end_time}`;
                    timeSlots.appendChild(slotLink);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                const timeSlots = document.getElementById('time-slots');
                timeSlots.innerHTML = `<p class="text-danger">خطا در دریافت زمان‌ها: ${error.message}</p>`;
            });
    } // پایان تابع loadTimes
</script>
{% endblock %}