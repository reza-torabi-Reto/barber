<!-- salon/templates/salon/book_appointment.html -->
{% extends 'base.html' %}
{% load static %}
{% block title %}رزرو نوبت - {{ shop.name }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1>رزرو نوبت - {{ shop.name }}</h1>
    
    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    <form method="post" id="appointment-form">
        {% csrf_token %}
        <div class="row">
            {% for barber in barbers %}
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <div class="form-check">
                                <input class="form-check-input barber-radio" type="radio" 
                                       name="barber_id" value="{{ barber.id }}" 
                                       id="barber_{{ barber.id }}" required
                                       onchange="toggleServices({{ barber.id }})">
                                <label class="form-check-label" for="barber_{{ barber.id }}">
                                    {{ barber.nickname }}
                                </label>
                            </div>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">خدمات</h5>
                            <div class="services-list" id="services_{{ barber.id }}" style="display: none;">
                                {% for service in barber.barber_profile.services.all %}
                                    <div class="form-check">
                                        <input class="form-check-input service-checkbox" 
                                               type="checkbox" 
                                               name="services" 
                                               value="{{ service.id }}"
                                               data-price="{{ service.price }}"
                                               data-duration="{{ service.duration }}"
                                               id="service_{{ service.id }}"
                                               onchange="updateTotals()">
                                        <label class="form-check-label" for="service_{{ service.id }}">
                                            {{ service.name }} ({{ service.price }} تومان، {{ service.duration }} دقیقه)
                                        </label>
                                    </div>
                                {% empty %}
                                    <p>هیچ خدمتی برای این آرایشگر ثبت نشده است.</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="col-12">
                    <p class="text-muted">هیچ آرایشگر فعالی در این آرایشگاه یافت نشد.</p>
                </div>
            {% endfor %}
        </div>

        <div class="mt-4">
            <h4>جمع کل:</h4>
            <p>قیمت کل: <span id="total-price">0</span> تومان</p>
            <p>مدت زمان کل: <span id="total-duration">0</span> دقیقه</p>
        </div>

        <button type="submit" class="btn btn-primary mt-3">مرحله بعد</button>
        <a href="{% url 'account:customer_profile' %}" class="btn btn-secondary mt-3">بازگشت</a>
    </form>
</div>

<script>
function toggleServices(barberId) {
    // مخفی کردن همه لیست‌های خدمات
    document.querySelectorAll('.services-list').forEach(list => {
        list.style.display = 'none';
    });
    
    // نمایش لیست خدمات آرایشگر انتخاب‌شده
    const servicesList = document.getElementById(`services_${barberId}`);
    if (servicesList) {
        servicesList.style.display = 'block';
    }

    // ریست کردن چک‌باکس‌های خدمات آرایشگران دیگر
    document.querySelectorAll('.service-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });

    // به‌روزرسانی جمع کل
    updateTotals();
}

function updateTotals() {
    let totalPrice = 0;
    let totalDuration = 0;

    // جمع‌آوری خدمات انتخاب‌شده
    document.querySelectorAll('.service-checkbox:checked').forEach(checkbox => {
        totalPrice += parseFloat(checkbox.dataset.price);
        totalDuration += parseInt(checkbox.dataset.duration);
    });

    // نمایش مقادیر
    document.getElementById('total-price').textContent = totalPrice.toLocaleString('fa-IR');
    document.getElementById('total-duration').textContent = totalDuration;
}
</script>
{% endblock %}