<!-- salon/book_appointment.html -->
<!DOCTYPE html>
<html>
<head>
    <title>رزرو نوبت - {{ shop.name }}</title>
    <style>
        .service-container { margin-bottom: 10px; }
    </style>
</head>
<body>
    <h1>رزرو نوبت در {{ shop.name }}</h1>
    <form method="post" id="appointment-form">
        {% csrf_token %}
        {% if form.errors %}
            <div style="color: red;">
                <p>لطفاً خطاهای زیر را برطرف کنید:</p>
                <ul>
                    {% for field, errors in form.errors.items %}
                        <li>{{ field }}: {{ errors }}</li>
                    {% endfor %}
                    {% if form.non_field_errors %}
                        <li>{{ form.non_field_errors }}</li>
                    {% endif %}
                </ul>
            </div>
        {% endif %}
        <p>
            <label>سرویس‌ها:</label><br>
            {% for service in form.services.field.queryset %}
                <div class="service-container">
                    <input type="checkbox" name="services" value="{{ service.id }}" id="service-{{ service.id }}"
                           onchange="updateTotals()">
                    <label for="service-{{ service.id }}">{{ service.name }}</label>
                </div>
            {% endfor %}
            {{ form.services.errors }}
        </p>
        <p>
            <label for="{{ form.barber.id_for_label }}">آرایشگر:</label>
            {{ form.barber }}
        </p>
        <p>
            <label for="{{ form.date.id_for_label }}">تاریخ:</label>
            {{ form.date }}
        </p>
        <p>
            <label for="{{ form.time.id_for_label }}">زمان:</label>
            {{ form.time }}
        </p>
        <p>
            <strong>قیمت کل:</strong> <span id="total-price">0</span> تومان<br>
            <strong>مدت زمان کل:</strong> <span id="total-duration">0</span> دقیقه
        </p>
        <button type="submit">رزرو نوبت</button>
    </form>
    <a href="{% url 'account:customer_profile' %}">بازگشت به پروفایل</a>

    <script>
        // گرفتن اطلاعات سرویس‌ها
        const servicesData = [];
        fetch(`/salon/get_shop_details/?shop_id={{ shop.id }}`)
            .then(response => response.json())
            .then(data => {
                data.services.forEach(service => {
                    servicesData[service.id] = {
                        price: parseFloat(service.price),
                        duration: parseInt(service.duration)
                    };
                });
                console.log('Services data:', servicesData);
                updateTotals(); // آپدیت اولیه بعد از لود داده‌ها
            })
            .catch(error => console.error('Error fetching shop details:', error));

        // محاسبه قیمت و مدت زمان کل
        function updateTotals() {
            let totalPrice = 0;
            let totalDuration = 0;
            const selectedServices = [];
            document.querySelectorAll('input[name="services"]:checked').forEach(checkbox => {
                const serviceId = checkbox.value;
                if (servicesData[serviceId]) {
                    totalPrice += servicesData[serviceId].price;
                    totalDuration += servicesData[serviceId].duration;
                    selectedServices.push(serviceId);
                }
            });
            document.getElementById('total-price').textContent = totalPrice.toFixed(0); // بدون اعشار
            document.getElementById('total-duration').textContent = totalDuration;
            updateAvailableTimes(selectedServices);
        }

        // آپدیت زمان‌های آزاد
        function updateAvailableTimes(selectedServices) {
            const barberId = document.getElementById('id_barber').value;
            const date = document.getElementById('id_date').value;
            if (barberId && date && selectedServices.length > 0) {
                const serviceParams = selectedServices.map(id => `services=${id}`).join('&');
                fetch(`/salon/get-available-times/?shop_id={{ shop.id }}&barber_id=${barberId}&date=${date}&${serviceParams}`)
                    .then(response => response.json())
                    .then(data => {
                        const timeSelect = document.getElementById('id_time');
                        timeSelect.innerHTML = '<option value="">---------</option>';
                        data.times.forEach(time => {
                            const option = document.createElement('option');
                            option.value = time;
                            option.text = time;
                            timeSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error fetching available times:', error));
            }
        }

        // رویدادها
        document.querySelectorAll('input[name="services"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateTotals);
        });
        document.getElementById('id_barber').addEventListener('change', updateTotals);
        document.getElementById('id_date').addEventListener('change', updateTotals);

        // آپدیت اولیه
        updateTotals();
    </script>
</body>
</html>